import type { EcLevel, Version } from './types.ts';
import { versionFetch } from './version.ts';

// GF(256) exponential and logarithm tables
const EXP_TABLE = new Uint8Array([
  1, 2, 4, 8, 16, 32, 64, 128, 29, 58, 116, 232, 205, 135, 19, 38, 76, 152, 45, 90, 180, 117, 234, 201, 143, 3,
  6, 12, 24, 48, 96, 192, 157, 39, 78, 156, 37, 74, 148, 53, 106, 212, 181, 119, 238, 193, 159, 35, 70, 140, 5,
  10, 20, 40, 80, 160, 93, 186, 105, 210, 185, 111, 222, 161, 95, 190, 97, 194, 153, 47, 94, 188, 101, 202, 137,
  15, 30, 60, 120, 240, 253, 231, 211, 187, 107, 214, 177, 127, 254, 225, 223, 163, 91, 182, 113, 226, 217, 175,
  67, 134, 17, 34, 68, 136, 13, 26, 52, 104, 208, 189, 103, 206, 129, 31, 62, 124, 248, 237, 199, 147, 59, 118,
  236, 197, 151, 51, 102, 204, 133, 23, 46, 92, 184, 109, 218, 169, 79, 158, 33, 66, 132, 21, 42, 84, 168, 77,
  154, 41, 82, 164, 85, 170, 73, 146, 57, 114, 228, 213, 183, 115, 230, 209, 191, 99, 198, 145, 63, 126, 252,
  229, 215, 179, 123, 246, 241, 255, 227, 219, 171, 75, 150, 49, 98, 196, 149, 55, 110, 220, 165, 87, 174, 65,
  130, 25, 50, 100, 200, 141, 7, 14, 28, 56, 112, 224, 221, 167, 83, 166, 81, 162, 89, 178, 121, 242, 249, 239,
  195, 155, 43, 86, 172, 69, 138, 9, 18, 36, 72, 144, 61, 122, 244, 245, 247, 243, 251, 235, 203, 139, 11, 22,
  44, 88, 176, 125, 250, 233, 207, 131, 27, 54, 108, 216, 173, 71, 142, 1,
]);

const LOG_TABLE = new Uint8Array([
  255, 0, 1, 25, 2, 50, 26, 198, 3, 223, 51, 238, 27, 104, 199, 75, 4, 100, 224, 14, 52, 141, 239, 129, 28, 193,
  105, 248, 200, 8, 76, 113, 5, 138, 101, 47, 225, 36, 15, 33, 53, 147, 142, 218, 240, 18, 130, 69, 29, 181, 194,
  125, 106, 39, 249, 185, 201, 154, 9, 120, 77, 228, 114, 166, 6, 191, 139, 98, 102, 221, 48, 253, 226, 152, 37,
  179, 16, 145, 34, 136, 54, 208, 148, 206, 143, 150, 219, 189, 241, 210, 19, 92, 131, 56, 70, 64, 30, 66, 182,
  163, 195, 72, 126, 110, 107, 58, 40, 84, 250, 133, 186, 61, 202, 94, 155, 159, 10, 21, 121, 43, 78, 212, 229,
  172, 115, 243, 167, 87, 7, 112, 192, 247, 140, 128, 99, 13, 103, 74, 222, 237, 49, 197, 254, 24, 227, 165, 153,
  119, 38, 184, 180, 124, 17, 68, 146, 217, 35, 32, 137, 46, 55, 63, 209, 91, 149, 188, 207, 205, 144, 135, 151,
  178, 220, 252, 190, 97, 242, 86, 211, 171, 20, 42, 93, 158, 132, 60, 57, 83, 71, 109, 65, 162, 31, 45, 67, 216,
  183, 123, 164, 118, 196, 23, 73, 236, 127, 12, 111, 246, 108, 161, 59, 82, 41, 157, 85, 170, 251, 96, 134, 177,
  187, 204, 62, 90, 203, 89, 95, 176, 156, 169, 160, 81, 11, 245, 22, 235, 122, 117, 44, 215, 79, 174, 213, 233,
  230, 231, 173, 232, 116, 214, 244, 234, 168, 80, 88, 175,
]);

// Generator polynomials table
const GENERATOR_POLYNOMIALS: Uint8Array[] = [];
function initGeneratorPolynomials() {
  if (GENERATOR_POLYNOMIALS.length > 0) return;
  GENERATOR_POLYNOMIALS.push(new Uint8Array([]));
  GENERATOR_POLYNOMIALS.push(new Uint8Array([0]));
  GENERATOR_POLYNOMIALS.push(new Uint8Array([25, 1]));
  GENERATOR_POLYNOMIALS.push(new Uint8Array([198, 199, 3]));
  GENERATOR_POLYNOMIALS.push(new Uint8Array([75, 249, 78, 6]));
  GENERATOR_POLYNOMIALS.push(new Uint8Array([113, 164, 166, 119, 10]));
  GENERATOR_POLYNOMIALS.push(new Uint8Array([166, 0, 134, 5, 176, 15]));
  GENERATOR_POLYNOMIALS.push(new Uint8Array([87, 229, 146, 149, 238, 102, 21]));
  GENERATOR_POLYNOMIALS.push(new Uint8Array([175, 238, 208, 249, 215, 252, 196, 28]));
  GENERATOR_POLYNOMIALS.push(new Uint8Array([95, 246, 137, 231, 235, 149, 11, 123, 36]));
  GENERATOR_POLYNOMIALS.push(new Uint8Array([251, 67, 46, 61, 118, 70, 64, 94, 32, 45]));
  for (let i = 11; i <= 68; i++) {
    GENERATOR_POLYNOMIALS.push(new Uint8Array(i));
  }
}
initGeneratorPolynomials();

/** EC bytes per block from ISO/IEC 18004:2006 Table 9 */
const EC_BYTES_PER_BLOCK: ReadonlyArray<readonly [number, number, number, number]> = [
  [7, 10, 13, 17],
  [10, 16, 22, 28],
  [15, 26, 18, 22],
  [20, 18, 26, 16],
  [26, 24, 18, 22],
  [18, 16, 24, 28],
  [20, 18, 18, 26],
  [24, 22, 22, 26],
  [30, 22, 20, 24],
  [18, 26, 24, 28],
  [20, 30, 28, 24],
  [24, 22, 26, 28],
  [26, 22, 24, 22],
  [30, 24, 20, 24],
  [22, 24, 30, 24],
  [24, 28, 24, 30],
  [28, 28, 28, 28],
  [30, 26, 28, 28],
  [28, 26, 26, 26],
  [28, 26, 30, 28],
  [28, 26, 28, 30],
  [28, 28, 30, 24],
  [30, 28, 30, 30],
  [30, 28, 30, 30],
  [26, 28, 30, 30],
  [28, 28, 28, 30],
  [30, 28, 30, 30],
  [30, 28, 30, 30],
  [30, 28, 30, 30],
  [30, 28, 30, 30],
  [30, 28, 30, 30],
  [30, 28, 30, 30],
  [30, 28, 30, 30],
  [30, 28, 30, 30],
  [30, 28, 30, 30],
  [30, 28, 30, 30],
  [30, 28, 30, 30],
  [30, 28, 30, 30],
  [30, 28, 30, 30],
  [30, 28, 30, 30],
];

type BlockInfo = readonly [number, number, number, number];
const DATA_BYTES_PER_BLOCK: ReadonlyArray<readonly [BlockInfo, BlockInfo, BlockInfo, BlockInfo]> = [
  [[19, 1, 0, 0], [16, 1, 0, 0], [13, 1, 0, 0], [9, 1, 0, 0]],
  [[34, 1, 0, 0], [28, 1, 0, 0], [22, 1, 0, 0], [16, 1, 0, 0]],
  [[55, 1, 0, 0], [44, 1, 0, 0], [17, 2, 0, 0], [13, 2, 0, 0]],
  [[80, 1, 0, 0], [32, 2, 0, 0], [24, 2, 0, 0], [9, 4, 0, 0]],
  [[108, 1, 0, 0], [43, 2, 0, 0], [15, 2, 16, 2], [11, 2, 12, 2]],
  [[68, 2, 0, 0], [27, 4, 0, 0], [19, 4, 0, 0], [15, 4, 0, 0]],
  [[78, 2, 0, 0], [31, 4, 0, 0], [14, 2, 15, 4], [13, 4, 14, 1]],
  [[97, 2, 0, 0], [38, 2, 39, 2], [18, 4, 19, 2], [14, 4, 15, 2]],
  [[116, 2, 0, 0], [36, 3, 37, 2], [16, 4, 17, 4], [12, 4, 13, 4]],
  [[68, 2, 69, 2], [43, 4, 44, 1], [19, 6, 20, 2], [15, 6, 16, 2]],
  [[81, 4, 0, 0], [50, 1, 51, 4], [22, 4, 23, 4], [12, 3, 13, 8]],
  [[92, 2, 93, 2], [36, 6, 37, 2], [20, 4, 21, 6], [14, 7, 15, 4]],
  [[107, 4, 0, 0], [37, 8, 38, 1], [20, 8, 21, 4], [11, 12, 12, 4]],
  [[115, 3, 116, 1], [40, 4, 41, 5], [16, 11, 17, 5], [12, 11, 13, 5]],
  [[87, 5, 88, 1], [41, 5, 42, 5], [24, 5, 25, 7], [12, 11, 13, 7]],
  [[98, 5, 99, 1], [45, 7, 46, 3], [19, 15, 20, 2], [15, 3, 16, 13]],
  [[107, 1, 108, 5], [46, 10, 47, 1], [22, 1, 23, 15], [14, 2, 15, 17]],
  [[120, 5, 121, 1], [43, 9, 44, 4], [22, 17, 23, 1], [14, 2, 15, 19]],
  [[113, 3, 114, 4], [44, 3, 45, 11], [21, 17, 22, 4], [13, 9, 14, 16]],
  [[107, 3, 108, 5], [41, 3, 42, 13], [24, 15, 25, 5], [15, 15, 16, 10]],
  [[116, 4, 117, 4], [42, 17, 0, 0], [22, 17, 23, 6], [16, 19, 17, 6]],
  [[111, 2, 112, 7], [46, 17, 0, 0], [24, 7, 25, 16], [13, 34, 0, 0]],
  [[121, 4, 122, 5], [47, 4, 48, 14], [24, 11, 25, 14], [15, 16, 16, 14]],
  [[117, 6, 118, 4], [45, 6, 46, 14], [24, 11, 25, 16], [16, 30, 17, 2]],
  [[106, 8, 107, 4], [47, 8, 48, 13], [24, 7, 25, 22], [15, 22, 16, 13]],
  [[114, 10, 115, 2], [46, 19, 47, 4], [22, 28, 23, 6], [16, 33, 17, 4]],
  [[122, 8, 123, 4], [45, 22, 46, 3], [23, 8, 24, 26], [15, 12, 16, 28]],
  [[117, 3, 118, 10], [45, 3, 46, 23], [24, 4, 25, 31], [15, 11, 16, 31]],
  [[116, 7, 117, 7], [45, 21, 46, 7], [23, 1, 24, 37], [15, 19, 16, 26]],
  [[115, 5, 116, 10], [47, 19, 48, 10], [24, 15, 25, 25], [15, 23, 16, 25]],
  [[115, 13, 116, 3], [46, 2, 47, 29], [24, 42, 25, 1], [15, 23, 16, 28]],
  [[115, 17, 0, 0], [46, 10, 47, 23], [24, 10, 25, 35], [15, 19, 16, 35]],
  [[115, 17, 116, 1], [46, 14, 47, 21], [24, 29, 25, 19], [15, 11, 16, 46]],
  [[115, 13, 116, 6], [46, 14, 47, 23], [24, 44, 25, 7], [16, 59, 17, 1]],
  [[121, 12, 122, 7], [47, 12, 48, 26], [24, 39, 25, 14], [15, 22, 16, 41]],
  [[121, 6, 122, 14], [47, 6, 48, 34], [24, 46, 25, 10], [15, 2, 16, 64]],
  [[122, 17, 123, 4], [46, 29, 47, 14], [24, 49, 25, 10], [15, 24, 16, 46]],
  [[122, 4, 123, 18], [46, 13, 47, 32], [24, 48, 25, 14], [15, 42, 16, 32]],
  [[117, 20, 118, 4], [47, 40, 48, 7], [24, 43, 25, 22], [15, 10, 16, 67]],
  [[118, 19, 119, 6], [47, 18, 48, 31], [24, 34, 25, 34], [15, 20, 16, 61]],
];

/** Creates error correction code */
export function createErrorCorrectionCode(data: Uint8Array, ecCodeSize: number): Uint8Array {
  const dataLen = data.length;
  const logDen = GENERATOR_POLYNOMIALS[ecCodeSize]!;

  const res = new Uint8Array(ecCodeSize + dataLen);
  res.set(data);

  for (let i = 0; i < dataLen; i++) {
    const leadCoeff = res[i]!;
    if (leadCoeff === 0) continue;

    const logLeadCoeff = LOG_TABLE[leadCoeff]!;
    for (let j = 0; j < logDen.length; j++) {
      res[i + 1 + j]! ^= EXP_TABLE[(logDen[j]! + logLeadCoeff) % 255]!;
    }
  }

  return res.slice(dataLen);
}

/** Interleaves blocks */
function interleave<T>(blocks: T[][]): T[] {
  const lastBlockLen = blocks[blocks.length - 1]!.length;
  const res: T[] = [];
  for (let i = 0; i < lastBlockLen; i++) {
    for (const block of blocks) {
      if (i < block.length) {
        res.push(block[i]!);
      }
    }
  }
  return res;
}

/** Constructs data and error correction codewords */
export function constructCodewords(
  rawbits: Uint8Array,
  version: Version,
  ecLevel: EcLevel
): [Uint8Array, Uint8Array] {
  const [block1Size, block1Count, block2Size] = versionFetch(version, ecLevel, DATA_BYTES_PER_BLOCK);

  const block1End = block1Size * block1Count;

  // Divide data into blocks
  const blocks: Uint8Array[] = [];
  for (let i = 0; i < block1End; i += block1Size) {
    blocks.push(rawbits.slice(i, i + block1Size));
  }
  if (block2Size > 0) {
    for (let i = block1End; i < rawbits.length; i += block2Size) {
      blocks.push(rawbits.slice(i, i + block2Size));
    }
  }

  // Generate EC codes
  const ecBytes = versionFetch(version, ecLevel, EC_BYTES_PER_BLOCK);
  const ecCodes = blocks.map((block) => Array.from(createErrorCorrectionCode(block, ecBytes)));

  const blocksVec = new Uint8Array(interleave(blocks.map((b) => Array.from(b))));
  const ecVec = new Uint8Array(interleave(ecCodes));

  return [blocksVec, ecVec];
}
